schemaVersion: 2.2.0
metadata:
  name: custom-udi-java11
  displayName: "Java 11 (Maven 3.6.3 / Gradle 7.6.6 / Spring Boot CLI 2.7.18)"
  description: "Java 11 para Maven 3.6.3, Gradle 7.6.6, Spring Boot CLI 2.7.18"
  version: 1.0.0
  tags: ["java", "spring", "maven", "gradle"]
components:
  - name: tools
    container:
      image: quay.io/marolive/custom-udi-java11:1.0.0
      mountSources: true
      sourceMapping: /projects
      command: ["bash", "-lc", "sleep infinity"]
      memoryLimit: 2Gi
      memoryRequest: 1Gi
      cpuLimit: "1"
      cpuRequest: "0.5"
      env:
        - name: MAVEN_OPTS
          value: "-Dmaven.repo.local=/home/user/persistent/.m2/repository"
        - name: GRADLE_USER_HOME
          value: "/home/user/persistent/.gradle"
        - name: NEXUS_BASEURL
          value: "https://<NEXUSREPOSITORY>:8443/repository/public-yum-central"
        - name: NEXUS_MAVEN_BASEURL
          value: "https://<NEXUSREPOSITORY>:8443/repository/public-maven-central/"
      volumeMounts:
        - name: persistent-storage
          path: /home/user/persistent
      endpoints:
        - name: http-8080
          targetPort: 8080
          protocol: http
          exposure: public
  - name: persistent-storage
    volume:
      size: 1Gi
commands:
  - id: verify
    exec:
      component: tools
      commandLine: |
        set -euo pipefail
        echo "== Java (default) =="
        java -version
        echo "JAVA_HOME=$JAVA_HOME"
        echo ""
        echo "== Maven/Gradle/Spring CLI =="
        mvn -version | head -n 5
        gradle --version | head -n 8
        spring --version || true
      workingDir: /projects
      group:
        kind: run
        isDefault: true
  - id: setup-cache
    exec:
      component: tools
      commandLine: |
        set -euo pipefail
        mkdir -p /home/user/persistent/.m2/repository
        mkdir -p /home/user/persistent/.gradle
      workingDir: /projects
  - id: configure-yum-repo
    exec:
      component: tools
      commandLine: "sed \"s|NEXUS_BASEURL_PLACEHOLDER|$NEXUS_BASEURL|g\" /etc/yum.repos.d/nexus-repo > /tmp/repo.tmp && cat /tmp/repo.tmp > /etc/yum.repos.d/nexus-repo"
  - id: configure-maven-repo
    exec:
      component: tools
      commandLine: "sed \"s|NEXUS_MAVEN_BASEURL_PLACEHOLDER|$NEXUS_MAVEN_BASEURL|g\" ~/.m2/settings.xml > /tmp/repo-maven.tmp && cat /tmp/repo-maven.tmp > ~/.m2/settings.xml"
events:
  postStart:
    - setup-cache
    - configure-yum-repo
    - configure-maven-repo
    - verify
